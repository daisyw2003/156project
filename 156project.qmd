---
title: "156project"
format:
  pdf:
        fontsize: 10pt
        fig_width: 6in
        fig_height: 4in
        geometry: margin=.5in
---

```{r}
library(haven)
table_A1 <- read_dta("table_A1.dta") 
table_5 <- read_dta("table_5.dta")
aej_maindata <- read_dta("aej_maindata.dta") 
```



```{r}
library(AER)       # For ivreg

# Dependent variable: lngini_w
model_lngini_w_count1920 <- ivreg(
  lngini_w ~ dism1990 + lenper + count1920 | lenper + count1920 + herf,
  data = aej_maindata
)
model_lngini_w_black1920 <- ivreg(
  lngini_w ~ dism1990 + lenper + black1920 | lenper + black1920 + herf,
  data = aej_maindata
)
model_lngini_w_ctyliterate1920 <- ivreg(
  lngini_w ~ dism1990 + lenper + ctyliterate1920 | lenper + ctyliterate1920 + herf,
  data = aej_maindata
)
model_lngini_w_ctymanuf_wkrs1920 <- ivreg(
  lngini_w ~ dism1990 + lenper + ctymanuf_wkrs1920 | lenper + ctymanuf_wkrs1920 + herf,
  data = aej_maindata
)
model_lngini_w_lfp1920 <- ivreg(
  lngini_w ~ dism1990 + lenper + lfp1920 | lenper + lfp1920 + herf,
  data = aej_maindata
)
model_lngini_w_herfscore <- ivreg(
  lngini_w ~ dism1990 + lenper + herfscore | lenper + herfscore + herf,
  data = aej_maindata
)

# Dependent variable: lngini_b
model_lngini_b_count1920 <- ivreg(
  lngini_b ~ dism1990 + lenper + count1920 | lenper + count1920 + herf,
  data = aej_maindata
)
model_lngini_b_black1920 <- ivreg(
  lngini_b ~ dism1990 + lenper + black1920 | lenper + black1920 + herf,
  data = aej_maindata
)
model_lngini_b_ctyliterate1920 <- ivreg(
  lngini_b ~ dism1990 + lenper + ctyliterate1920 | lenper + ctyliterate1920 + herf,
  data = aej_maindata
)
model_lngini_b_ctymanuf_wkrs1920 <- ivreg(
  lngini_b ~ dism1990 + lenper + ctymanuf_wkrs1920 | lenper + ctymanuf_wkrs1920 + herf,
  data = aej_maindata
)
model_lngini_b_lfp1920 <- ivreg(
  lngini_b ~ dism1990 + lenper + lfp1920 | lenper + lfp1920 + herf,
  data = aej_maindata
)
model_lngini_b_herfscore <- ivreg(
  lngini_b ~ dism1990 + lenper + herfscore | lenper + herfscore + herf,
  data = aej_maindata
)

# Dependent variable: povrate_w
model_povrate_w_count1920 <- ivreg(
  povrate_w ~ dism1990 + lenper + count1920 | lenper + count1920 + herf,
  data = aej_maindata
)
model_povrate_w_black1920 <- ivreg(
  povrate_w ~ dism1990 + lenper + black1920 | lenper + black1920 + herf,
  data = aej_maindata
)
model_povrate_w_ctyliterate1920 <- ivreg(
  povrate_w ~ dism1990 + lenper + ctyliterate1920 | lenper + ctyliterate1920 + herf,
  data = aej_maindata
)
model_povrate_w_ctymanuf_wkrs1920 <- ivreg(
  povrate_w ~ dism1990 + lenper + ctymanuf_wkrs1920 | lenper + ctymanuf_wkrs1920 + herf,
  data = aej_maindata
)
model_povrate_w_lfp1920 <- ivreg(
  povrate_w ~ dism1990 + lenper + lfp1920 | lenper + lfp1920 + herf,
  data = aej_maindata
)
model_povrate_w_herfscore <- ivreg(
  povrate_w ~ dism1990 + lenper + herfscore | lenper + herfscore + herf,
  data = aej_maindata
)

# Dependent variable: povrate_b
model_povrate_b_count1920 <- ivreg(
  povrate_b ~ dism1990 + lenper + count1920 | lenper + count1920 + herf,
  data = aej_maindata
)
model_povrate_b_black1920 <- ivreg(
  povrate_b ~ dism1990 + lenper + black1920 | lenper + black1920 + herf,
  data = aej_maindata
)
model_povrate_b_ctyliterate1920 <- ivreg(
  povrate_b ~ dism1990 + lenper + ctyliterate1920 | lenper + ctyliterate1920 + herf,
  data = aej_maindata
)
model_povrate_b_ctymanuf_wkrs1920 <- ivreg(
  povrate_b ~ dism1990 + lenper + ctymanuf_wkrs1920 | lenper + ctymanuf_wkrs1920 + herf,
  data = aej_maindata
)
model_povrate_b_lfp1920 <- ivreg(
  povrate_b ~ dism1990 + lenper + lfp1920 | lenper + lfp1920 + herf,
  data = aej_maindata
)
model_povrate_b_herfscore <- ivreg(
  povrate_b ~ dism1990 + lenper + herfscore | lenper + herfscore + herf,
  data = aej_maindata
)

```

```{r}
summary(model_lngini_w_count1920)
summary(model_lngini_b_count1920)
summary(model_povrate_w_count1920)
summary(model_povrate_b_count1920)

```

**Daisy's Section?**

Table 1—Testing RDI as an Instrument

```{r}
library(lmtest)
library(sandwich)

# Assuming your data is stored in a data.frame called 'aej_maindata'

# Table 1, OLS regressions with robust standard errors
reg1 <- lm(dism1990 ~ herf + lenper, data = aej_maindata)
coeftest(reg1, vcov = vcovHC(reg1, type = "HC1"))

reg2 <- lm(area1910/1000 ~ herf + lenper, data = aej_maindata)
coeftest(reg2, vcov = vcovHC(reg2, type = "HC1"))

reg3 <- lm(count1910/1000 ~ herf + lenper, data = aej_maindata)
coeftest(reg3, vcov = vcovHC(reg3, type = "HC1"))

reg4 <- lm(ethseg10 ~ herf + lenper, data = aej_maindata)
coeftest(reg4, vcov = vcovHC(reg4, type = "HC1"))

reg5 <- lm(ethiso10 ~ herf + lenper, data = aej_maindata)
coeftest(reg5, vcov = vcovHC(reg5, type = "HC1"))

reg6 <- lm(black1910 ~ herf + lenper, data = aej_maindata)
coeftest(reg6, vcov = vcovHC(reg6, type = "HC1"))

reg7 <- lm(passpc/1000 ~ herf + lenper, data = aej_maindata)
coeftest(reg7, vcov = vcovHC(reg7, type = "HC1"))

reg8 <- lm(black1920 ~ herf + lenper, data = aej_maindata)
coeftest(reg8, vcov = vcovHC(reg8, type = "HC1"))

reg9 <- lm(ctyliterate1920 ~ herf + lenper, data = aej_maindata)
coeftest(reg9, vcov = vcovHC(reg9, type = "HC1"))

reg10 <- lm(lfp1920 ~ herf + lenper, data = aej_maindata)
coeftest(reg10, vcov = vcovHC(reg10, type = "HC1"))

reg11 <- lm(ctytrade_wkrs1920 ~ herf + lenper, data = aej_maindata)
coeftest(reg11, vcov = vcovHC(reg11, type = "HC1"))

reg12 <- lm(ctymanuf_wkrs1920 ~ herf + lenper, data = aej_maindata)
coeftest(reg12, vcov = vcovHC(reg12, type = "HC1"))

reg13 <- lm(ctyrail_wkrs1920 ~ herf + lenper, data = aej_maindata)
coeftest(reg13, vcov = vcovHC(reg13, type = "HC1"))

reg14 <- lm(incseg ~ herf + lenper, data = aej_maindata)
coeftest(reg14, vcov = vcovHC(reg14, type = "HC1"))

```

Table 2—The Effects of Segregation on Poverty and Inequality among Blacks and Whites

```{r}
library(AER)
library(lmtest)
library(sandwich)

#Within-race poverty and inequality Gini index (1st row and 1-2 col of the table)
reg_lngini_w <- lm(lngini_w ~ dism1990, data = aej_maindata)
coeftest(reg_lngini_w, vcov = vcovHC(reg_lngini_w, type = "HC1"))

reg_lngini_b <- lm(lngini_b ~ dism1990, data = aej_maindata)
coeftest(reg_lngini_b, vcov = vcovHC(reg_lngini_b, type = "HC1"))

#Poverty rate (2nd row, col 1-2)
reg_povrate_w <- lm(povrate_w ~ dism1990, data = aej_maindata)
coeftest(reg_povrate_w, vcov = vcovHC(reg_povrate_w, type = "HC1"))

reg_povrate_b <- lm(povrate_b ~ dism1990, data = aej_maindata)
coeftest(reg_povrate_b, vcov = vcovHC(reg_povrate_b, type = "HC1"))
```

```{r}
# Table 2, Panel 1 - IV regressions
ivreg1 <- ivreg(lngini_w ~ dism1990 | herf, data = aej_maindata)
summary(ivreg1, robust = TRUE)

ivreg2 <- ivreg(lngini_b ~ dism1990 | herf, data = aej_maindata)
summary(ivreg2, robust = TRUE)

ivreg3 <- ivreg(povrate_w ~ dism1990 | herf, data = aej_maindata)
summary(ivreg3, robust = TRUE)

ivreg4 <- ivreg(povrate_b ~ dism1990 | herf, data = aej_maindata)
summary(ivreg4, robust = TRUE)

# Table 2, Panel 1 (Subset)
reg15 <- lm(lngini_w ~ herf + lenper, data = aej_maindata, subset = closeness < -400)
coeftest(reg15, vcov = vcovHC(reg15, type = "HC1"))

reg16 <- lm(lngini_b ~ herf + lenper, data = aej_maindata, subset = closeness < -400)
coeftest(reg16, vcov = vcovHC(reg16, type = "HC1"))

reg17 <- lm(povrate_w ~ herf + lenper, data = aej_maindata, subset = closeness < -400)
coeftest(reg17, vcov = vcovHC(reg17, type = "HC1"))

reg18 <- lm(povrate_b ~ herf + lenper, data = aej_maindata, subset = closeness < -400)
coeftest(reg18, vcov = vcovHC(reg18, type = "HC1"))

```

```{r}
# Table 2, Panel 2 - OLS regressions
reg19 <- lm(ln90w90b ~ dism1990, data = aej_maindata)
coeftest(reg19, vcov = vcovHC(reg19, type = "HC1"))

reg20 <- lm(ln10w10b ~ dism1990, data = aej_maindata)
coeftest(reg20, vcov = vcovHC(reg20, type = "HC1"))

reg21 <- lm(ln90w10b ~ dism1990, data = aej_maindata)
coeftest(reg21, vcov = vcovHC(reg21, type = "HC1"))

reg22 <- lm(ln90b10w ~ dism1990, data = aej_maindata)
coeftest(reg22, vcov = vcovHC(reg22, type = "HC1"))

# Table 2, Panel 2 - IV regressions
ivreg5 <- ivreg(ln90w90b ~ dism1990 | herf, data = aej_maindata)
summary(ivreg5, robust = TRUE)

ivreg6 <- ivreg(ln10w10b ~ dism1990 | herf, data = aej_maindata)
summary(ivreg6, robust = TRUE)

ivreg7 <- ivreg(ln90w10b ~ dism1990 | herf, data = aej_maindata)
summary(ivreg7, robust = TRUE)

ivreg8 <- ivreg(ln90b10w ~ dism1990 | herf, data = aej_maindata)
summary(ivreg8, robust = TRUE)

# Table 2, Panel 2 (Subset condition)
reg23 <- lm(ln90w90b ~ herf + lenper, data = aej_maindata, subset = closeness < -400)
coeftest(reg23, vcov = vcovHC(reg23, type = "HC1"))

reg24 <- lm(ln10w10b ~ herf + lenper, data = aej_maindata, subset = closeness < -400)
coeftest(reg24, vcov = vcovHC(reg24, type = "HC1"))

reg25 <- lm(ln90w10b ~ herf + lenper, data = aej_maindata, subset = closeness < -400)
coeftest(reg25, vcov = vcovHC(reg25, type = "HC1"))

reg26 <- lm(ln90b10w ~ herf + lenper, data = aej_maindata, subset = closeness < -400)
coeftest(reg26, vcov = vcovHC(reg26, type = "HC1"))
```

```{r}
sapply(aej_maindata[, c("dism1990_binary", "lenper", "pop1990", "pctbk1990")], function(x) sum(is.na(x)))

```

```{r}

# Define the binary treatment variable
aej_maindata$dism1990_binary <- as.numeric(aej_maindata$dism1990 > median(aej_maindata$dism1990, na.rm = TRUE))

# Propensity score model
propensity_model <- glm(
  dism1990_binary ~ lenper,
  family = binomial,
  data = aej_maindata
)

# Extract propensity scores
aej_maindata$propensity_score <- predict(propensity_model, type = "response")


# IPW weights
aej_maindata$ipw_weights <- ifelse(
  aej_maindata$dism1990_binary == 1,
  1 / aej_maindata$propensity_score,
  1 / (1 - aej_maindata$propensity_score)
)

# Check weight distribution
summary(aej_maindata$ipw_weights)
hist(aej_maindata$ipw_weights, main = "Distribution of IPW Weights", xlab = "IPW Weights")

```


```{r}
# IPW-weighted regressions
ipw_gini_w <- lm(lngini_w ~ dism1990, weights = ipw_weights, data = aej_maindata)
ipw_gini_b <- lm(lngini_b ~ dism1990, weights = ipw_weights, data = aej_maindata)
ipw_povrate_w <- lm(povrate_w ~ dism1990, weights = ipw_weights, data = aej_maindata)
ipw_povrate_b <- lm(povrate_b ~ dism1990, weights = ipw_weights, data = aej_maindata)


ipw_ln90w90b <- lm(ln90w90b ~ dism1990, weights = ipw_weights, data = aej_maindata)
ipw_ln10w10b <- lm(ln10w10b ~ dism1990, weights = ipw_weights, data = aej_maindata)
ipw_ln90w10b <- lm(ln90w10b ~ dism1990, weights = ipw_weights, data = aej_maindata)
ipw_ln90b10w <- lm(ln90b10w ~ dism1990, weights = ipw_weights, data = aej_maindata)


```

```{r}

library(stargazer)

# Panel 1: Within-Race Inequality and Poverty
stargazer(
  ipw_gini_w, ipw_gini_b, ipw_povrate_w, ipw_povrate_b,
  title = "Panel 1: IPW Estimates for Within-Race Inequality and Poverty",
  type = "text",
  column.labels = c("Gini (Whites)", "Gini (Blacks)", "Poverty (Whites)", "Poverty (Blacks)"),
  digits = 3
)

# Panel 2: Between-Race Inequality
stargazer(
  ipw_ln90w90b, ipw_ln10w10b, ipw_ln90w10b, ipw_ln90b10w,
  title = "Panel 2: IPW Estimates for Between-Race Inequality",
  type = "text",
  column.labels = c("90:90", "10:10", "90:10 (White:Black)", "90:10 (Black:White)"),
  digits = 3
)


```





```{r}
# Loading data for DR estimation
library(AER)
library(lmtest)
library(sandwich)
library(tidyverse)
library(haven)
aej_maindata <- read_dta("aej_maindata.dta")
```


```{r}

### Step 1: Propensity Score Model (IPW Part)

# Estimate propensity scores using a logistic regression model
propensity_model <- glm(
  dism1990_binary ~ lenper, 
  family = binomial(link = "logit"), 
  data = aej_maindata
)

# Predict propensity scores
aej_maindata$propensity_score <- predict(propensity_model, type = "response")

# Prevent extreme propensity scores to avoid large weights
epsilon <- 1e-5
aej_maindata$propensity_score <- pmax(pmin(aej_maindata$propensity_score, 1 - epsilon), epsilon)

# Calculate IPW weights based on propensity scores
aej_maindata$ipw_weights <- ifelse(
  aej_maindata$dism1990_binary == 1,
  1 / aej_maindata$propensity_score,
  1 / (1 - aej_maindata$propensity_score)
)

# Check the distribution of the IPW weights
summary(aej_maindata$ipw_weights)
hist(aej_maindata$ipw_weights, main = "Distribution of IPW Weights", xlab = "IPW Weights")

### Step 2: Doubly Robust Estimation Function

doubly_robust_estimation <- function(outcome_var) {
  
  # Outcome Regression (OR) model including covariate lenper
  outcome_formula <- as.formula(paste(outcome_var, "~ dism1990 + lenper"))
  outcome_model <- lm(outcome_formula, data = aej_maindata)
  
  # Predict outcome based on the OR model
  aej_maindata[[paste0("outcome_prediction_", outcome_var)]] <- predict(outcome_model)
  
  # Calculate the DR outcome by combining OR predictions and IPW-adjusted residuals
  aej_maindata[[paste0("dr_outcome_", outcome_var)]] <- aej_maindata[[paste0("outcome_prediction_", outcome_var)]] +
    aej_maindata$ipw_weights * (aej_maindata[[outcome_var]] - aej_maindata[[paste0("outcome_prediction_", outcome_var)]])
  
  # Regression of the DR-adjusted outcome on the treatment indicator
  dr_formula <- as.formula(paste(paste0("dr_outcome_", outcome_var), "~ dism1990"))
  dr_model <- lm(dr_formula, data = aej_maindata)
  
  # Return only the lm object, without any extra processing
  return(dr_model)
}

# Run DR estimation for each dependent variable using lapply
# DR Estimation for All Dependent Variables
dr_results <- lapply(c(
  "lngini_w", "lngini_b", "povrate_w", "povrate_b",
  "ln90w90b", "ln10w10b", "ln90w10b", "ln90b10w"
), doubly_robust_estimation)

# Assign names to the results for easy identification
names(dr_results) <- c(
  "DR_lngini_w", "DR_lngini_b", 
  "DR_povrate_w", "DR_povrate_b",
  "DR_ln90w90b", "DR_ln10w10b", 
  "DR_ln90w10b", "DR_ln90b10w"
)

dr_results

```


```{r}
# Output as a table on stargazer
library(stargazer)

# Creating a list of regression models for stargazer
dr_models <- lapply(dependent_vars, doubly_robust_estimation)

# Pass the models to stargazer
stargazer(dr_models, type = "text", title = "Doubly Robust Estimation Results")
```

